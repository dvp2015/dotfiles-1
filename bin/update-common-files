#!/bin/bash

my_pkg() {
    local dir="$(basename $(readlink -e .))"
    local pkg="${dir//-/_}"
    echo "$pkg"
}

check_pair() {
    local left="$1"
    local right="$2"
    if [[ ! -f $left ]]; then
        echo "Left file $left doesn't exist"
        return 0
    fi
    if [[ ! -f $right ]]; then
        echo "Right file $right doesn't exist"
        return 0
    fi
    if [[ -n "$(diff -q $left $right)" ]]; then
        meld $left $right
    else
        echo "Files $left and $right don't differ"
    fi
}

main() {
    local pkg="${1:-$(my_pkg)}"
    local ref="${2:-mckit-nuclides}"
    local refpkg="${ref//-/_}"
    echo "Target package $pkg"
    echo "Reference      $refpkg"
    echo "----------------------"
    check_pair .flake8 "../${ref}/.flake8"
    check_pair .github/constraints.txt "../${ref}/.github/constraints.txt"
    check_pair .github/dependabot.yml "../${ref}/.github/dependabot.yml"
    check_pair .github/release-drafter.yml "../${ref}/.github/release-drafter.yml"
    check_pair .github/workflows/labeler.yml "../${ref}/.github/workflows/labeler.yml"
    check_pair .github/workflows/release-drafter.yml "../${ref}/.github/workflows/release-drafter.yml"
    check_pair .github/workflows/release.yml "../${ref}/.github/workflows/release.yml"
    check_pair .github/workflows/stale.yml "../${ref}/.github/workflows/stale.yml"
    check_pair .github/workflows/tests.yml "../${ref}/.github/workflows/tests.yml"
    check_pair noxfile.py "../${ref}/noxfile.py"
    check_pair .pre-commit-config.yaml "../${ref}/.pre-commit-config.yaml"
    check_pair pyproject.toml "../${ref}/pyproject.toml"
    check_pair tools/reset-pyenv "../${ref}/tools/reset-pyenv"
    check_pair tools/install-poetry "../${ref}/tools/install-poetry"
    check_pair "src/${pkg}/utils/resource.py" "../${ref}/src/${refpkg}/utils/resource.py"
    check_pair tests/utils/test_resource.py "../${ref}/tests/utils/test_resource.py"
}

main "$@"


# vim: set ts=4 sw=4 tw=92 ss=0 ft=sh et ai :
